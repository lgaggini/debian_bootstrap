---
- hosts: all
  tasks:
    - name: Update packages list
      apt: update_cache=yes

    - name: Put on hold Puppet Agent version
      dpkg_selections: name=puppet selection=hold

    - name: Dist upgrade packages
      apt: upgrade=dist

    - name: Check if a reboot is required
      register: file
      stat: path=/var/run/reboot-required get_md5=no

    - name: Reboot the server
      shell: 'sleep 5 && /sbin/reboot'
      when: file.stat.exists == true
      register: rebooted
      async: 1
      poll: 0

    - name: Waiting for server to come back after reboot
      wait_for_connection:
        delay: 20
        sleep: 5
        timeout: 300
      when: rebooted is changed

    - name: Puppet agent certificate client request
      shell: 'puppet agent -t --noop'
      ignore_errors: yes

    - name: Waiting for certificate request sign on puppetmaster
      pause: prompt='Waiting for certificate request sign on puppetmaster, press return to continue. Press Ctrl+c and then a to abort'

    - name: First full run of Puppet agent
      shell: 'puppet agent -t'
      ignore_errors: yes

    - name: First full run of Puppet agent
      shell: 'puppet agent -t'
      ignore_errors: yes
